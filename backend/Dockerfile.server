# äº‘æœåŠ¡å™¨ç‰ˆ Dockerfile
# é€‚ç”¨äºäº‘æœåŠ¡å™¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
# 
# ä½¿ç”¨æ–¹æ³•ï¼š
# 1. åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œï¼šdocker build -f backend/Dockerfile.server -t backend:latest .
# 2. è¿è¡Œå®¹å™¨ï¼šdocker run -d -p 8080:8080 --name backend \
#    -e SPRING_PROFILES_ACTIVE=prod \
#    -e SPRING_DATASOURCE_URL=jdbc:mysql://host.docker.internal:3306/test_user?useUnicode=true&characterEncoding=utf-8&serverTimezone=UTC \
#    -e SPRING_DATASOURCE_USERNAME=root \
#    -e SPRING_DATASOURCE_PASSWORD=your_password \
#    backend:latest

# å¤šé˜¶æ®µæ„å»ºï¼šå‡å°‘é•œåƒå¤§å°
FROM maven:3.8.6-openjdk-8 AS build
WORKDIR /app

# å¤åˆ¶pom.xmlï¼ˆåˆ©ç”¨Dockerç¼“å­˜å±‚ï¼‰
COPY backend/pom.xml .
# ä¸‹è½½ä¾èµ–ï¼ˆå¦‚æœpom.xmlæ²¡å˜ï¼Œè¿™å±‚ä¼šè¢«ç¼“å­˜ï¼‰
RUN mvn dependency:go-offline -B

# å¤åˆ¶æºç 
COPY backend/src ./src

# æ„å»ºåº”ç”¨ï¼ˆè·³è¿‡æµ‹è¯•ä»¥åŠ å¿«æ„å»ºï¼‰
RUN mvn clean package -DskipTests -B

# é‡å‘½å JAR æ–‡ä»¶ä¸º app.jarï¼ˆä¾¿äºåç»­å¤åˆ¶ï¼‰
RUN mv /app/target/backend-*.jar /app/app.jar

# è¿è¡Œé˜¶æ®µï¼šä½¿ç”¨æ›´å°çš„åŸºç¡€é•œåƒ
# æ³¨æ„ï¼šopenjdk é•œåƒå·²ä¸å†ç»´æŠ¤ï¼Œæ”¹ç”¨ Eclipse Temurinï¼ˆåŸ AdoptOpenJDKï¼‰
# Eclipse Temurin æ˜¯ OpenJDK çš„å®˜æ–¹æ›¿ä»£å“ï¼Œæ›´å¯é ä¸”æŒç»­ç»´æŠ¤
FROM eclipse-temurin:8-jre

WORKDIR /app

ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

RUN apt-get update && \
    apt-get install -y --no-install-recommends curl tzdata && \
    rm -rf /var/lib/apt/lists/*

RUN groupadd -r appuser && useradd -r -g appuser appuser

# ğŸ‘‡ ç›´æ¥å¤åˆ¶å·²é‡å‘½åçš„ JAR
COPY --from=build /app/app.jar .

RUN chown -R appuser:appuser /app

USER appuser

EXPOSE 8080

ENV JAVA_OPTS="-Xms256m -Xmx512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/app/heapdump.hprof -Djava.security.egd=file:/dev/./urandom -Duser.timezone=Asia/Shanghai"

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8080/api/dashboard/getUserFrequency || exit 1

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]

